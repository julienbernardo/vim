<?php


function log_query($function_name, $sql, $time) {
	$logfile = PATH_TMP.'query.txt';
	if(!is_file($logfile) || filesize($logfile)>100000) {
		$handle = fopen($logfile, 'w');
	} else {
		$handle = fopen($logfile, 'a+');
	}
	if($handle!==false) {
		fwrite($handle, date('Y-m-d H:i:s').' - '.$function_name.' ('.ceil($time*1000).'ms)');
		fwrite($handle, "\n".$sql."\n--\n");
		fclose($handle);
	}
}

/* Fonctions de traitement d'erreurs pour PEAR */
function pear_error_handler($error_obj) {
	global $db_data;
	error_log($error_obj->getMessage().": ".$error_obj->getDebugInfo());
    switch($error_obj->getCode()) {
        case "-24": // Erreur connexion
        	/*
        	if($db_data['mode']=='normal' || $db_data['mode']=='degraded'){
	        	// mise ?jout du fichier connector.php
	        	if($db_data['mode']=='degraded') $new_mode = 'down';
	        	else $new_mode ='degraded';
	        	$line = "<?php\n";
				$line.= "$"."db_data 						= array();\n";
				foreach($db_data['pool'] as $key => $value){
					if($key==$db_data['name']){
						$line.= "$"."db_data['pool']['".$key."'] 		= array('STATUS'=>'".$new_mode."','NAME'=>'".$value['NAME']."','DSN'=> '".$value['DSN']."', 'DSN_DEGRADED'=> '".$value['DSN_DEGRADED']."');\n";
					}else{
						$line.= "$"."db_data['pool']['".$key."'] 		= array('STATUS'=>'".$value['STATUS']."','NAME'=>'".$value['NAME']."','DSN'=> '".$value['DSN']."', 'DSN_DEGRADED'=> '".$value['DSN_DEGRADED']."');\n";
					}
				}
				$line.= "?>";
				$fh = fopen(DB_CONNECTOR, 'w');
				fwrite($fh, $line);
				fclose($fh);
				// reload viewer
				if($db_data['mode']=='normal'){
					header("Location:".$_SERVER['REQUEST_URI']);
					exit;
				}
			}
			*/
			header('Location: /unavailable.php');
			exit;
            break;
        case "-2": // Erreur syntaxe SQL
        case "-1":
            echo "Sorry, your request cannot be processed now... Please retry later...";
            break;
    }
    exit;
}


function db_query($sql,$db="TOUR",$r=0){
	global $_bench;
	global $db_data;
	if(array_key_exists($db, $db_data['pool'])){ $db_data['name'] = $db;}

	if(!isset($db_data['mode'])) $db_data['mode'] = $db_data['pool'][$db_data['name']]['STATUS'];
	if($db_data['mode']=='down'){
		header('Location: /unavailable.php');
		exit;
	}else if($db_data['mode']=='degraded'){
		if(eregi('insert|update|delete',$sql)) return;
	}
	if($sql!=""){
		$sql = "--VID_\n ".$sql;
		if(!isset($db_data['conn'][$db]['CONN'])){
			if($db_data['mode']=='degraded'){
				$dsn = $db_data['pool'][$db_data['name']]['DSN_DEGRADED'];
				$name = $db_data['pool'][$db_data['name']]['NAME']." degraded";
			}else{
				$dsn = $db_data['pool'][$db_data['name']]['DSN'];
				$name = $db_data['pool'][$db_data['name']]['NAME'];
			}

			if(count($db_data['conn']) > 0){
				foreach($db_data['conn'] as $key => $value){
					if($value['DSN']==$dsn && $key!=$db){
						$db_data['conn'][$db]['CONN'] = $db_data['conn'][$key]['CONN'];
						$_bench['use_existing_db_conn '.$name] = getmicrotime();
						break;
					}
				}
			}
			
			$db_data['conn'][$db]['DSN'] = $dsn;
			if(!isset($db_data['conn'][$db]['CONN'])){
				$_bench['start_connecting_db '.$name] = getmicrotime();
				PEAR::setErrorHandling(PEAR_ERROR_CALLBACK, 'pear_error_handler');
				$db_data['conn'][$db]['CONN'] = DB::connect($dsn);
				$temp_dsn = eregi("@(.*)\?",$dsn,$regs);
				$_bench['connected to '.$regs[1]] = getmicrotime();
			}
		}
		if($r==0) return $db_data['conn'][$db]['CONN']->query($sql);
		else return $db_data['conn'][$db]['CONN']->getOne($sql);
	}
}

function db_close($db = "") {
	global $_bench;
	global $db_data;
	if(is_array($db_data['conn'])){
		foreach($db_data['conn'] as $key => $value){
			if($db == "" || $db == $key){
				if(isset($value['CONN'])){
					$value['CONN']->disconnect();
					$_bench['disconnect_db '.$key] = getmicrotime();
					$db_data['conn'][$key] = null;
				}
			}
		}
	}
}

function db_getOne($sql,$db="TOUR"){
	return db_query($sql,$db,1);
}

/**
*
*	PREVISITE_REALESTATE
*
**/
function get_tour_data($id_visite, $nolimit = false, $partner = ""){
	global $db_data;
//ADDRESS, AGENT_EMAIL, AGENT_FIRST_NAME, AGENT_LAST_NAME, AGENT_PHONE, CITY, COMPANY_ADDRESS, COMPANY_EMAIL, COMPANY_NAME, COMPANY_URL, ID_MLS, LATITUDE, LISTED_DATE, LISTING_STATUS, LISTING_TYPE, LONGITUDE, LOT_SIZE, NB_BATHROOM, NB_BEDROOM, NEIGHBORHOOD, PRICE, SQUARE_FEET, STATE, YEAR_BUILT, ZIP
	$data_array = array();
	
	$use_ws = true;

	if($use_ws) {
		$url = str_replace('#TOUR#', $id_visite, URL_GET_TOUR_INFOS);
		$json = json_decode(file_get_contents($url), true);

		if(!empty($json['TOUR']) && ($nolimit || $json['TOUR']['ID_STATUT_VISITE']>=0)) {
			// dev.api.previsite.com/emailing/
			$data_array = array(
				'ID_VISITE' => $json['TOUR']['ID_VISITE'],
				'ID_TEMPLATE' => $json['TOUR']['ID_TEMPLATE'],
				'ID_PAYS' => $json['TOUR']['ID_PAYS'],
				'REF_ETAT' => $json['TOUR']['REF_ETAT'],
				'ADRESSE' => $json['TOUR']['ADRESSE'],
				'VILLE' => $json['TOUR']['VILLE'],
				'CODE_POSTAL' => $json['TOUR']['CODE_POSTAL'],
				'SYMBOLE_DEVISE' => $json['TOUR']['SYMBOLE_DEVISE'],
				'SYMBOLEBRUT_DEVISE' => $json['TOUR']['SYMBOLEBRUT_DEVISE'],
				'ID_UTILISATEUR' => $json['TOUR']['ID_UTILISATEUR'],
				'PRIX_BIEN' => $json['TOUR']['PRIX_BIEN'],
				'REF_VOICE' => $json['TOUR']['REF_VOICE'],
				'REF_VISITE' => $json['TOUR']['REF_VISITE'],
				'ID_MUSIQUE_VIDEO' => $json['TOUR']['ID_MUSIQUE_VIDEO'],
				'LONGITUDE' => $json['TOUR']['LONGITUDE'],
				'LATITUDE' => $json['TOUR']['LATITUDE'],
				'URL_ANNONCE' => $json['TOUR']['URL_ANNONCE'],
				'TYPE_SON' => $json['TOUR']['TYPE_SON'],
				'ID_SOCIETE' => $json['TOUR']['ID_SOCIETE'],
				'NOM_VISITE' => $json['TOUR']['NOM_VISITE'],
				'DESCRIPTION' => $json['TOUR']['DESCRIPTION'],
				'ID_LANGUE' => $json['TOUR']['ID_LANGUE'],
				'ID_TYPE_TRANSACTION' => $json['TOUR']['ID_TYPE_TRANSACTION'],
				'ID_ADRESSE_CACHEE' => $json['TOUR']['ID_ADRESSE_CACHEE'],
				'ID_TYPE_BIEN' => $json['TOUR']['ID_TYPE_BIEN'],
				'NOM_TYPE_BIEN' => $json['TOUR']['TYPE_BIEN'],
				'NB_ROOM' => $json['TOUR']['NB_ROOM'],
				'NB_BEDROOM' => $json['TOUR']['NB_BEDROOM'],
				'NB_BATHROOM' => $json['TOUR']['NB_BATHROOM'],
				'DPE_LETTRE' => $json['TOUR']['DPE_LETTRE'],
				'DPE_VALEUR' => $json['TOUR']['DPE_VALEUR'],
				'GES_LETTRE' => $json['TOUR']['GES_LETTRE'],
				'GES_VALEUR' => $json['TOUR']['GES_VALEUR'],
			);
		
		}
	} else if(is_guid($id_visite)){
//		$sql = 
//"SELECT
//	v.ID_VISITE,ID_TEMPLATE,ID_PAYS,REF_ETAT,ADRESSE ,VILLE ,CODE_POSTAL ,SYMBOLE_DEVISE, SYMBOLEBRUT_DEVISE,ID_UTILISATEUR,PRIX_BIEN,REF_VOICE, REF_VISITE,ID_MUSIQUE_VIDEO,
//	LONGITUDE,LATITUDE, URL_ANNONCE, ID_PAYS, TYPE_SON, ID_SOCIETE, 
//	vt.NOM_VISITE, vt.DESCRIPTION, vt.ID_LANGUE
//FROM
//	VISITE V
//	LEFT JOIN DEVISE D ON D.REF_DEVISE = V.REF_DEVISE
//	LEFT JOIN VISITE_TEXTE vt ON V.ID_VISITE=vt.ID_VISITE AND v.ID_LANGUE COLLATE FRENCH_CI_AS = vt.ID_LANGUE COLLATE FRENCH_CI_AS
//WHERE
//	V.ID_VISITE='".$id_visite."' ".(!$nolimit ? "AND ID_STATUT_VISITE > -1" : "");

//	  	$result = db_query($sql, $db_data['name']);
//	  	if($row = $result->fetchRow(DB_FETCHMODE_ASSOC)) {
//	  		$data_array = $row;
//	  		if($data_array['ID_TEMPLATE'] != '21'){
//	  			$sql = "SELECT ID_TYPE_TRANSACTION, ID_ADRESSE_CACHEE, VISITE_TPL_EU.ID_TYPE_BIEN, NOM_TYPE_BIEN TYPE_BIEN, NOMBRE_PIECE NB_ROOM, NOMBRE_CHAMBRE NB_BEDROOM, NOMBRE_SALLE_BAIN NB_BATHROOM, SURFACE_HABITABLE SQUARE_FEET, NOM_UNITE_SURFACE, DPE_LETTRE, DPE_VALEUR, GES_LETTRE, GES_VALEUR FROM VISITE_TPL_EU LEFT JOIN TYPE_BIEN ON TYPE_BIEN.ID_TYPE_BIEN=VISITE_TPL_EU.ID_TYPE_BIEN INNER JOIN UNITE_SURFACE ON UNITE_SURFACE.ID_UNITE_SURFACE=VISITE_TPL_EU.ID_UNITE_SURFACE_HABITABLE WHERE ID_VISITE='".$id_visite."'";
//	  		}else{
//	  			$sql = "SELECT ID_TYPE_TRANSACTION,ID_ADRESSE_CACHEE,VISITE_TPL_US.ID_TYPE_BIEN, NOM_TYPE_BIEN TYPE_BIEN,NOMBRE_CHAMBRE NB_BEDROOM,NOMBRE_SALLE_BAIN NB_BATHROOM,ESPACE_TOTAL SQUARE_FEET FROM VISITE_TPL_US LEFT JOIN VISITE_TPL_US_TYPE_BIEN ON VISITE_TPL_US_TYPE_BIEN.ID_TYPE_BIEN=VISITE_TPL_US.ID_TYPE_BIEN WHERE ID_VISITE='".$id_visite."'";
//	  		}
//	  		$result = db_query($sql,$db_data['name']);
//	  		if($row = $result->fetchRow(DB_FETCHMODE_ASSOC)) {
//	  			if($row['ID_TYPE_BIEN'] == '99'){ $row['TYPE_BIEN'] = "";}
//	  			$data_array = array_merge($data_array,$row);
//	  		}
			
//			$sql = "SELECT NOM_TYPE_BIEN FROM TYPE_BIEN_DISTRIBUTEUR INNER JOIN SOCIETE ON SOCIETE.ID_DISTRIBUTEUR=TYPE_BIEN_DISTRIBUTEUR.ID_DISTRIBUTEUR WHERE ID_SOCIETE='".fix_text($data_array['ID_SOCIETE'])."' AND ID_LANGUE='".$data_array['ID_LANGUE']."' AND ID_TYPE_BIEN='".$data_array['ID_TYPE_BIEN']."'";
//			$result = db_getOne( $sql, $db_data['name']);
//			if($result != ""){ $data_array['TYPE_BIEN'] = $result;}
			
//	  	}
	}

	$sql = "SELECT TOP 1 ID_PLAN FROM [PLAN] WHERE ID_STATUT_PLAN >0 AND ID_VISITE='".$id_visite."' ORDER BY ORDRE_PLAN";
	$id_plan = db_getOne($sql,$db_data['name']);

	if(is_guid($id_plan)){
		$data_array['ID_PLAN'] = $id_plan;
	}

	if($data_array['URL_ANNONCE'] == ""){
		$sql = "SELECT VALEUR_OPTION FROM DIFFUSION_PORTAIL_OPTION INNER JOIN DIFFUSION_PORTAIL ON DIFFUSION_PORTAIL.ID_DIFFUSION_PORTAIL=DIFFUSION_PORTAIL_OPTION.ID_DIFFUSION_PORTAIL WHERE ID_VISITE='".$id_visite."' AND REF_OPTION='URL_ANNONCE'";
		$data_array['URL_ANNONCE'] = db_getOne($sql,$db_data['name']);
		if($data_array['URL_ANNONCE'] == ""){
			$data_array['URL_ANNONCE'] .= str_replace('#ID#', $id_visite, URL_VIEWER_DEFAULT);
		}
	}	  		
	if(is_guid($partner)){
		$sql = "SELECT REF_PORTAIL FROM DIFFUSION_PORTAIL WHERE ID_VISITE='".$id_visite."' AND ID_PORTAIL='".$partner."'";
		$data_array['REF_PORTAIL'] = db_getOne($sql, $db_data['name']);
	}
	return $data_array;
}

function get_user_data($user){
	global $db_data;
	$data_array = array();
	if(is_guid($user)){
		$sql =
		    "SELECT
			    u.ID_UTILISATEUR,s.ID_SOCIETE,s.ID_DISTRIBUTEUR,s.NOM_SOCIETE,s.REF_DEVISE,s.GROUPE_SOCIETE,s.COMMENTAIRE AS NOM_SOCIETE2,u.ID_STATUT_UTILISATEUR, s.SITEWEB_SOCIETE,
			    u.NOM_UTILISATEUR, u.PRENOM_UTILISATEUR, u.ID_CIVILITE_UTILISATEUR, u.EMAIL_UTILISATEUR, u.ID_LANGUE, u.TELEPHONE_UTILISATEUR, u.MOBILE_UTILISATEUR, u.ANGLE_LENTILLE,
			    a.TELEPHONE, a.ADRESSE, a.CODE_POSTAL, a.ETAT,a.ID_PAYS,a.VILLE, u.NOMBRE_IMAGES,u.FORMAT_AUTORISE,u.PHOTO_UTILISATEUR,u.VERSION_VIEWER,u.URL_PHOTO,u.LOGIN_UTILISATEUR,u.PASSWORD_UTILISATEUR,s.ID_PAYS,s.ID_TEMPLATE,s.LOGO_SOCIETE,
			    (SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='DATA_USER' AND REF_OPTION='IDLOGOUSER') AS ID_LOGO_USER,
			    (SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='DATA_USER' AND REF_OPTION='IDLOGOUSEREXT') AS ID_LOGO_USER_EXT,
   			    (SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='OPTION_BUNDLE' AND REF_OPTION='DEFAULTBGMUSIC') AS ID_MUSIQUE_USER,
				(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='DATA_USER' AND REF_OPTION='IDLOGOSOCIETE') AS ID_LOGO_SOCIETE,
				(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='DATA_USER' AND REF_OPTION='IDLOGOSOCIETEEXT') AS ID_LOGO_SOCIETE_EXT,
				(SELECT VALEUR_OPTION FROM DISTRIBUTEUR_OPTION WHERE ID_DISTRIBUTEUR=s.Id_DISTRIBUTEUR AND REF_CATEGORIE_OPTION='OPTION_DIFFUSION' AND REF_OPTION='LOGOAGENT') AS ID_LOGO_DISTRIB
			FROM UTILISATEUR u 
				INNER JOIN SOCIETE s ON u.ID_SOCIETE=s.ID_SOCIETE
				INNER JOIN ADRESSE a ON s.ID_ADRESSE_VIEWER=a.ID_ADRESSE
			WHERE u.ID_UTILISATEUR='".$user."' AND u.ID_STATUT_UTILISATEUR > '0' AND u.DATE_ACTIVATION <= GETDATE()";
		$result = db_query($sql,$db_data['name']);
		if($row = $result->fetchRow(DB_FETCHMODE_ASSOC)) {
			$data_array = $row;
			if(empty($data_array['ID_LOGO_SOCIETE_EXT'])) {
				$data_array['ID_LOGO_SOCIETE_EXT'] = 'jpg';
			}
			if(empty($data_array['ID_LOGO_USER_EXT'])) {
				$data_array['ID_LOGO_USER_EXT'] = 'jpg';
			}
		}
	}
	return $data_array;
}

//function get_image_list($tour,$orderby="i.POIDS",$top = "") {
//	global $db_data;
//	$data_array = array();
//	if(is_guid($tour)){
//		$sql = "SELECT i.ID_IMAGE, i.ID_TYPE_IMAGE, i.ID_TYPE_VUE,i.POIDS, t.NOM_IMAGE FROM IMAGE i LEFT JOIN TITRE_IMAGE t ON i.ID_IMAGE=t.ID_IMAGE WHERE i.ID_VISITE='".$tour."' AND ID_STATUT_IMAGE > -1";
//		$result = db_query($sql,$db_data['name']);
//		while($row = $result->fetchRow(DB_FETCHMODE_ASSOC)){ 
//			$data_array[$row['POIDS']] = $row;
//		}
//		if(count($data_array) > 0){
//			ksort($data_array);
//			$tmp = $data_array;
//			$data_array = array();
//			foreach($tmp as $v){
//				$data_array[] = $v;
//				if($top != ""){	break;}
//			}
//		}
//	}
//	return $data_array;
//}

/**
*
* PREVISITE_VIDEO
*
**/
//function get_last_cron($filters = ""){
//	global $db_data;
//	$data_array = array();
//	$sql = "SELECT ID_VIDEO, ID_VISITE, DATE_CREATION_CRON, DATE_MODIFICATION_CRON, DATE_DERNIER_CRON, NOM_DISTRIBUTEUR, DISTRIBUTEUR.ID_DISTRIBUTEUR, ID_STATUT_CRON, DATE_CREATION_CRON FROM VIDEO_CRON INNER JOIN DISTRIBUTEUR ON VIDEO_CRON.ID_DISTRIBUTEUR=DISTRIBUTEUR.ID_DISTRIBUTEUR ORDER BY ID_STATUT_CRON DESC, DATE_DERNIER_CRON asc";
//	$result = db_query( $sql, $db_data['name']);
//	while($row = $result->fetchRow(DB_FETCHMODE_ASSOC)) { $data_array[] = $row;}
//	return $data_array;
//}

//function get_videos_need_rediffusion(){
//	global $db_data;
//	$data_array = array('DETAIL'=>array(), 'TOTAL'=>0);
//	$sql = "SELECT NOM_DISTRIBUTEUR,COUNT(*) NB FROM VIDEO INNER JOIN DISTRIBUTEUR ON DISTRIBUTEUR.ID_DISTRIBUTEUR=VIDEO.ID_DISTRIBUTEUR WHERE ID_STATUT_VIDEO='2' group by NOM_DISTRIBUTEUR";
//	$result = db_query($sql, $db_data['name']);
//	while($r = $result->fetchRow(DB_FETCHMODE_ASSOC)){
//		$data_array['DETAIL'][$r['NOM_DISTRIBUTEUR']] = $r['NB'];
//		$data_array['TOTAL'] += $r['NB'];
//	}
//	return $data_array;
//}


//function get_last_conversions($filters = ""){
//	global $db_data;
//	$data_array = array();
//	$sql = "SELECT ID_VISITE, ID_CONVERSION, DATE_MODIFICATION_CONVERSION, REF_VIDEO_PROFIL, VIDEO.ID_VIDEO, DATE_DEMANDE_CONVERSION, DATE_TRAITEMENT_CONVERSION, ID_STATUT_CONVERSION, TAILLE_VIDEO, NB_IMAGE, XML_SOURCE_CONVERSION, DATE_FIN_CONVERSION, RESULT_CODE_CONVERSION, RESULT_TEXT_CONVERSION, REF_VIDEO, TYPE_CONVERSION, TYPE_VIDEO, ID_CRON, ID_STATUT_VIDEO FROM VIDEO_CONVERSION RIGHT JOIN VIDEO ON VIDEO.ID_VIDEO=VIDEO_CONVERSION.ID_VIDEO ".($filters != "" ? $filters : "")." ORDER BY DATE_MODIFICATION_CONVERSION DESC";
//	$time = microtime(true);
//	$result = db_query( $sql, $db_data['name']);
//	log_query(__FUNCTION__, $sql, microtime(true)-$time);
//	while($row = $result->fetchRow(DB_FETCHMODE_ASSOC)) {
//		if(!is_guid($row['ID_CONVERSION'])){  $row['ID_CONVERSION'] = $row['ID_VIDEO'];}
//		if(!is_array($data_array[$row['ID_CONVERSION']])){ $data_array[$row['ID_CONVERSION']] = array();}
//		$data_array[$row['ID_CONVERSION']][$row['REF_VIDEO_PROFIL']] = $row;
//	}
//	return $data_array;
//}

function update_login_diffusion($id, $site, $oldLogin, $login, $password){
	global $db_data;
	$return = false;
	if(is_guid($id) && $site != "" && $login != "" /*&& $oldLogin != ""*/){
		if($login != $oldLogin && $oldLogin != ""){
			$sql = "SELECT ID_VIDEO, ID_STATUT_DIFFUSION, RESULT_CODE_DIFFUSION FROM VIDEO_DIFFUSION WHERE ID_VIDEO='".$id."' AND SITE_DIFFUSION='".strtoupper($site)."' AND LOGIN_DIFFUSION='".fix_text($login)."'";
			echo $sql;
			$result = db_query( $sql, $db_data['name']);
			$row = $result->fetchRow(DB_FETCHMODE_ASSOC);
			if(is_guid($row['ID_VIDEO'])){
				echo ($row['ID_STATUT_DIFFUSION'] > 0 && $row['RESULT_CODE_DIFFUSION'] == 0 ? "true" : "false");
				if(($row['ID_STATUT_DIFFUSION'] < 0 && $row['RESULT_CODE_DIFFUSION'] < -1) || ($row['ID_STATUT_DIFFUSION'] > 0 && $row['RESULT_CODE_DIFFUSION'] == 0) ){
					return false;
				}else{
					$sql = "DELETE FROM VIDEO_DIFFUSION WHERE ID_VIDEO='".$id."' AND SITE_DIFFUSION='".strtoupper($site)."' AND LOGIN_DIFFUSION='".fix_text($login)."'";
					db_query($sql, $db_data['name']);
				}
			}
			$sql = "SELECT ID_VIDEO, ID_STATUT_DIFFUSION FROM VIDEO_DIFFUSION WHERE ID_VIDEO='".$id."' AND SITE_DIFFUSION='".strtoupper($site)."' AND LOGIN_DIFFUSION='".fix_text($oldLogin)."'";
			$result = db_query( $sql, $db_data['name']);
			$row = $result->fetchRow(DB_FETCHMODE_ASSOC);
			$sql = "";
			if(is_guid($row['ID_VIDEO'])){
				$sql = "UPDATE VIDEO_DIFFUSION SET DATE_MODIFICATION_DIFFUSION='".date('Y-m-d H:i:s')."', LOGIN_DIFFUSION='".fix_text($login)."', PASSWORD_DIFFUSION='".fix_text($password)."' WHERE ID_VIDEO='".$id."' AND SITE_DIFFUSION='".strtoupper($site)."' AND LOGIN_DIFFUSION='".fix_text($oldLogin)."'";
			}
			if($sql != ""){	db_query( $sql, $db_data['name']);}
		}
		$return = true;
	}
	return $return;
}

function update_video_diffusion($id, $site, $login, $password=""){
	global $db_data;
	$return = false;
	if(is_guid($id) && $site != "" && $login != ""){
		$sql = "SELECT ID_VIDEO, ID_STATUT_DIFFUSION FROM VIDEO_DIFFUSION WHERE ID_VIDEO='".$id."' AND SITE_DIFFUSION='".strtoupper($site)."' AND LOGIN_DIFFUSION='".fix_text($login)."'";
		$result = db_query( $sql, $db_data['name']);
		$row = $result->fetchRow(DB_FETCHMODE_ASSOC);
		$sql = "";
		if(!is_guid($row['ID_VIDEO'])){
			$sql = "INSERT INTO VIDEO_DIFFUSION(ID_VIDEO, SITE_DIFFUSION, LOGIN_DIFFUSION, ID_STATUT_DIFFUSION, PASSWORD_DIFFUSION, DATE_CREATION_DIFFUSION, DATE_MODIFICATION_DIFFUSION,RESULT_CODE_DIFFUSION) VALUES('".$id."', '".strtoupper($site)."', '".fix_text($login)."', '1','".fix_text($password)."', '".date('Y-m-d H:i:s')."', '".date('Y-m-d H:i:s')."','0')";
		}else if($row['ID_STATUT_DIFFUSION'] !== "" && $row['ID_STATUT_DIFFUSION'] != 1){
			$sql = "UPDATE VIDEO_DIFFUSION SET DATE_MODIFICATION_DIFFUSION='".date('Y-m-d H:i:s')."', ID_STATUT_DIFFUSION=1 WHERE ID_VIDEO='".$id."' AND SITE_DIFFUSION='".strtoupper($site)."' AND LOGIN_DIFFUSION='".fix_text($login)."'";
		}
		if($sql != ""){
			db_query( $sql, $db_data['name']);
			$return = true;
		}
	}
	return $return;
}

function get_video_infos_for_diffusion($id, $tour, $type = "", $site = "", $login = "", $ref ="", $delete = false, $url = ""){
	global $db_data;
	$data_array = array();
	//ajout pour fixage diffusion
	if((is_guid($tour) || is_guid($id)) && $type =="" && $url != ""){
		$sql = "SELECT TYPE_VIDEO, VIDEO.ID_VISITE, VIDEO.ID_VIDEO, SITE_DIFFUSION, LOGIN_DIFFUSION, PASSWORD_DIFFUSION, ID_STATUT_DIFFUSION, RESULT_CODE_DIFFUSION, URL_VIDEO_DIFFUSION FROM VIDEO_DIFFUSION INNER JOIN VIDEO ON VIDEO.ID_VIDEO=VIDEO_DIFFUSION.ID_VIDEO WHERE ".(is_guid($id) ? "ID_VIDEO='".$id."'" : "ID_VISITE='".$tour."'")." AND URL_VIDEO_DIFFUSION='".fix_text($url)."'";
		$result = db_query( $sql, $db_data['name']);
		if($r = $result->fetchRow(DB_FETCHMODE_ASSOC)){
			$id = $r['ID_VIDEO'];
			$tour = $r['ID_VISITE'];
			$type = $r['TYPE_VIDEO'];
			$site = $r['SITE_DIFFUSION'];
			unset($r['ID_VIDEO']);
			$data_array = $r;
		}
	}
	if((is_guid($tour) || is_guid($id)) && $type !="" && $site != "" /*&& $login != ""*/){
		if($ref != "" && is_guid($tour)){
			$sql = "SELECT SITE_DIFFUSION, VIDEO.ID_VIDEO, VISITE.ID_VISITE, ID_STATUT_VISITE, REF_VIDEO, DATE_MODIFICATION_VIDEO, ID_STATUT_VIDEO, DISTRIBUTEUR.ID_DISTRIBUTEUR, DISTRIBUTEUR.NOM_DISTRIBUTEUR, TYPE_VIDEO, PROFIL_AVAILABLE, DUREE_CONVERSION, WAIT_TTS, ID_CRON, NB_CONVERSIONS, URL_VIDEO_DIFFUSION FROM VIDEO INNER JOIN DISTRIBUTEUR ON DISTRIBUTEUR.ID_DISTRIBUTEUR=VIDEO.ID_DISTRIBUTEUR INNER JOIN VISITE ON VISITE.ID_VISITE=VIDEO.ID_VISITE INNER JOIN VIDEO_DIFFUSION ON VIDEO_DIFFUSION.ID_VIDEO=VIDEO.ID_VIDEO WHERE VIDEO.ID_VISITE='".$tour."' AND URL_VIDEO_DIFFUSION LIKE '%".fix_text($ref)."%'";
			$result = db_query( $sql, $db_data['name']);
			if($r = $result->fetchRow(DB_FETCHMODE_ASSOC)) $data_array = array_merge($data_array, $r);
		}
		if(!is_guid($data_array['ID_VIDEO'])){
			$sql="SELECT VIDEO.ID_VIDEO, VISITE.ID_VISITE, ID_STATUT_VISITE, REF_VIDEO, DATE_MODIFICATION_VIDEO, ID_STATUT_VIDEO, DISTRIBUTEUR.ID_DISTRIBUTEUR, DISTRIBUTEUR.NOM_DISTRIBUTEUR, TYPE_VIDEO, PROFIL_AVAILABLE, DUREE_CONVERSION, WAIT_TTS, ID_CRON, NB_CONVERSIONS FROM VIDEO INNER JOIN DISTRIBUTEUR ON DISTRIBUTEUR.ID_DISTRIBUTEUR=VIDEO.ID_DISTRIBUTEUR INNER JOIN VISITE ON VISITE.ID_VISITE=VIDEO.ID_VISITE WHERE ".(is_guid($tour) ? "VIDEO.ID_VISITE='".$tour."'" : "VIDEO.ID_VIDEO='".$id."'")." and TYPE_VIDEO='".$type."'";
			
			$result = db_query( $sql, $db_data['name']);
			if($r = $result->fetchRow(DB_FETCHMODE_ASSOC)) $data_array = array_merge($data_array, $r);
		}
		//dans le cas d'un delete demandé avec le mauvais profil
		if(!is_guid($data_array['ID_VIDEO']) && delete){
			$sql="SELECT SITE_DIFFUSION, VIDEO.ID_VIDEO, VISITE.ID_VISITE, ID_STATUT_VISITE, REF_VIDEO, DATE_MODIFICATION_VIDEO, ID_STATUT_VIDEO, DISTRIBUTEUR.ID_DISTRIBUTEUR, DISTRIBUTEUR.NOM_DISTRIBUTEUR, TYPE_VIDEO, PROFIL_AVAILABLE, DUREE_CONVERSION, WAIT_TTS, ID_CRON, NB_CONVERSIONS FROM VIDEO INNER JOIN DISTRIBUTEUR ON DISTRIBUTEUR.ID_DISTRIBUTEUR=VIDEO.ID_DISTRIBUTEUR INNER JOIN VISITE ON VISITE.ID_VISITE=VIDEO.ID_VISITE INNER JOIN VIDEO_DIFFUSION ON VIDEO_DIFFUSION.ID_VIDEO=VIDEO.ID_VIDEO WHERE ".(is_guid($tour) ? "VIDEO.ID_VISITE='".$tour."'" : "VIDEO.ID_VIDEO='".$id."'")." AND ID_STATUT_DIFFUSION >= 0 AND SITE_DIFFUSION='".fix_text($site)."'";	
			$result = db_query( $sql, $db_data['name']);
			$rows = array();
			while($row =  $result->fetchRow(DB_FETCHMODE_ASSOC)) $rows[] = $row;
			if(count($rows) == 1) $data_array = $rows[0];
		}
		
		if(is_guid($data_array['ID_VIDEO'])){
			$sql = "SELECT TOP 1 SITE_DIFFUSION, LOGIN_DIFFUSION, PASSWORD_DIFFUSION, URL_VIDEO_DIFFUSION, DATE_MODIFICATION_DIFFUSION, RESULT_CODE_DIFFUSION, RESULT_TEXT_DIFFUSION, RESULT_DESCRIPTION_DIFFUSION, URL_NOTIFICATION_DIFFUSION, ID_STATUT_DIFFUSION, TITLE_DIFFUSION FROM VIDEO_DIFFUSION WHERE ID_VIDEO='".$data_array['ID_VIDEO']."' AND SITE_DIFFUSION='".strtoupper($site)."' AND LOGIN_DIFFUSION='".fix_text($login)."' ORDER BY DATE_MODIFICATION_DIFFUSION DESC";
			$time = microtime(true);
			$result = db_query( $sql, $db_data['name']);
			log_query(__FUNCTION__, $sql, microtime(true)-$time);
			if($row = $result->fetchRow(DB_FETCHMODE_ASSOC) ){
				$data_array = array_merge($row, $data_array);
			}
		}
	}
	return $data_array;
}

//function get_video_infos($id_conversion){
//	global $db_data;
//	$data_array = array();

//	if(is_guid($id_conversion)){
//		$use_old_fields = db_getOne("SELECT COL_LENGTH('VISITE', 'DESCRIPTION')")>0;
		
//		$selected_fields = $use_old_fields ? ', VISITE.NOM_VISITE AS NOM_VISITE_OLD, VISITE.DESCRIPTION AS DESCRIPTION_OLD' : '';
		
//		$sql=
//"SELECT
//	VIDEO.ID_VIDEO, VISITE.ID_VISITE, REF_VIDEO, DATE_CREATION_VIDEO, DATE_MODIFICATION_VIDEO, ID_STATUT_VIDEO, 
//	PRIX_BIEN, DISTRIBUTEUR.ID_DISTRIBUTEUR, DISTRIBUTEUR.NOM_DISTRIBUTEUR, SYMBOLE_DEVISE, ADRESSE, VILLE, CODE_POSTAL, REF_ETAT, 
//	TYPE_VIDEO, ID_PAYS, PROFIL_AVAILABLE, DUREE_CONVERSION, URL_ANNONCE, WAIT_TTS, ID_CRON, NB_CONVERSIONS, VISITE.ID_LANGUE, 
//	ID_TEMPLATE,
//	VISITE_TEXTE.DESCRIPTION, VISITE_TEXTE.NOM_VISITE".$selected_fields."
//FROM
//	VIDEO 
//	INNER JOIN VIDEO_CONVERSION ON VIDEO_CONVERSION.ID_VIDEO=VIDEO.ID_VIDEO
//	INNER JOIN DISTRIBUTEUR ON DISTRIBUTEUR.ID_DISTRIBUTEUR=VIDEO.ID_DISTRIBUTEUR
//	INNER JOIN VISITE ON VISITE.ID_VISITE=VIDEO.ID_VISITE
//	INNER JOIN DEVISE ON DEVISE.REF_DEVISE=VISITE.REF_DEVISE
//	LEFT JOIN VISITE_TEXTE ON VISITE.ID_VISITE=VISITE_TEXTE.ID_VISITE AND VISITE.ID_LANGUE COLLATE FRENCH_CI_AS = VISITE_TEXTE.ID_LANGUE COLLATE FRENCH_CI_AS
//WHERE
//	ID_CONVERSION='".$id_conversion."'";

//		$time = microtime(true);
//		$result = db_query( $sql, $db_data['name']);
//		log_query(__FUNCTION__, $sql, microtime(true)-$time);

//		if($row = $result->fetchRow(DB_FETCHMODE_ASSOC)) { 
//			$data_array = $row;
//		}
//		else{
//			$sql = 
//"SELECT
//	VIDEO.ID_VIDEO, VISITE.ID_VISITE, REF_VIDEO, DATE_CREATION_VIDEO, DATE_MODIFICATION_VIDEO, ID_STATUT_VIDEO, PRIX_BIEN, DISTRIBUTEUR.ID_DISTRIBUTEUR, 
//	DISTRIBUTEUR.NOM_DISTRIBUTEUR, SYMBOLE_DEVISE, ADRESSE, VILLE, CODE_POSTAL, REF_ETAT, TYPE_VIDEO, ID_PAYS, PROFIL_AVAILABLE, DUREE_CONVERSION, 
//	URL_ANNONCE, WAIT_TTS, ID_CRON, NB_CONVERSIONS, VISITE.ID_LANGUE, ID_TEMPLATE,

//	VISITE_TEXTE.DESCRIPTION, VISITE_TEXTE.NOM_VISITE".$selected_fields."

//FROM
//	VIDEO 
//	LEFT JOIN VIDEO_CONVERSION ON VIDEO_CONVERSION.ID_VIDEO=VIDEO.ID_VIDEO 
//	INNER JOIN DISTRIBUTEUR ON DISTRIBUTEUR.ID_DISTRIBUTEUR=VIDEO.ID_DISTRIBUTEUR 
//	INNER JOIN VISITE ON VISITE.ID_VISITE=VIDEO.ID_VISITE 
//	INNER JOIN DEVISE ON DEVISE.REF_DEVISE=VISITE.REF_DEVISE 
//	LEFT JOIN VISITE_TEXTE ON VISITE.ID_VISITE=VISITE_TEXTE.ID_VISITE AND VISITE.ID_LANGUE COLLATE FRENCH_CI_AS = VISITE_TEXTE.ID_LANGUE COLLATE FRENCH_CI_AS
//WHERE
//	VIDEO.ID_VIDEO='".$id_conversion."'";
	
//			$time = microtime(true);
//			$result = db_query( $sql, $db_data['name']);
//			log_query(__FUNCTION__, $sql, microtime(true)-$time);
//			if($row = $result->fetchRow(DB_FETCHMODE_ASSOC)) { $data_array = $row;}

//			else{
//				$sql=
//"SELECT
//	VIDEO.ID_VIDEO, VISITE.ID_VISITE, REF_VIDEO, DATE_CREATION_VIDEO, DATE_MODIFICATION_VIDEO, ID_STATUT_VIDEO, PRIX_BIEN, DISTRIBUTEUR.ID_DISTRIBUTEUR, 
//	DISTRIBUTEUR.NOM_DISTRIBUTEUR, SYMBOLE_DEVISE, ADRESSE, VILLE, CODE_POSTAL, REF_ETAT, TYPE_VIDEO, ID_PAYS, PROFIL_AVAILABLE, DUREE_CONVERSION, URL_ANNONCE, 
//	WAIT_TTS, ID_CRON, NB_CONVERSIONS, VISITE.ID_LANGUE, ID_TEMPLATE, 

//	VISITE_TEXTE.DESCRIPTION, VISITE_TEXTE.NOM_VISITE".$selected_fields."

//FROM
//	VIDEO
//	INNER JOIN VIDEO_CONVERSION ON VIDEO_CONVERSION.ID_VIDEO=VIDEO.ID_VIDEO 
//	INNER JOIN DISTRIBUTEUR ON DISTRIBUTEUR.ID_DISTRIBUTEUR=VIDEO.ID_DISTRIBUTEUR 
//	INNER JOIN VISITE ON VISITE.ID_VISITE=VIDEO.ID_VISITE 
//	INNER JOIN DEVISE ON DEVISE.REF_DEVISE=VISITE.REF_DEVISE 
//	LEFT JOIN VISITE_TEXTE ON VISITE.ID_VISITE=VISITE_TEXTE.ID_VISITE AND VISITE.ID_LANGUE COLLATE FRENCH_CI_AS = VISITE_TEXTE.ID_LANGUE COLLATE FRENCH_CI_AS
//WHERE
//	VIDEO.ID_VISITE='".$id_conversion."'";
//				$time = microtime(true);
//				$result = db_query( $sql, $db_data['name']);
//				log_query(__FUNCTION__, $sql, microtime(true)-$time);
//				if($row = $result->fetchRow(DB_FETCHMODE_ASSOC)) { $data_array = $row;}
//			}
//		}
		
//		if(empty($data_array['NOM_VISITE'])) $data_array['NOM_VISITE'] = $data_array['NOM_VISITE_OLD'];
//		if(empty($data_array['DESCRIPTION'])) $data_array['DESCRIPTION'] = $data_array['DESCRIPTION_OLD'];

//		if(is_guid($data_array['ID_VIDEO'])){
//			$sql = "SELECT SITE_DIFFUSION, URL_VIDEO_DIFFUSION, RESULT_CODE_DIFFUSION, RESULT_TEXT_DIFFUSION, RESULT_DESCRIPTION_DIFFUSION FROM VIDEO_DIFFUSION WHERE ID_VIDEO='".$data_array['ID_VIDEO']."' AND ID_STATUT_DIFFUSION > 0";
//			$time = microtime(true);
//			$result = db_query( $sql, $db_data['name']);
//			log_query(__FUNCTION__, $sql, microtime(true)-$time);
//			$data_array['DIFFUSION'] = array();
//			while($row = $result->fetchRow(DB_FETCHMODE_ASSOC)) { $data_array['DIFFUSION'][] = $row;}
//		}
//		if(is_guid($data_array['ID_VISITE'])){
//			$sql = "SELECT ID_VIDEO,TYPE_VIDEO FROM VIDEO WHERE ID_VISITE='".$data_array['ID_VISITE']."' ORDER BY TYPE_VIDEO";
//			$result = db_query($sql, $db_data['name']);
//			$data_array['TYPE_VIDEO_AVAILABLE'] = array();
//			while($row = $result->fetchRow(DB_FETCHMODE_ASSOC)){ $data_array['TYPE_VIDEO_AVAILABLE'][$row['ID_VIDEO']] = $row['TYPE_VIDEO'];}
//	  		if($data_array['ID_TEMPLATE'] != '21'){
//	  			$sql = "SELECT ID_TYPE_TRANSACTION, ID_ADRESSE_CACHEE, VISITE_TPL_EU.ID_TYPE_BIEN, NOM_TYPE_BIEN TYPE_BIEN, NOMBRE_PIECE NB_ROOM, NOMBRE_CHAMBRE NB_BEDROOM, NOMBRE_SALLE_BAIN NB_BATHROOM, SURFACE_HABITABLE SQUARE_FEET, NOM_UNITE_SURFACE, DPE_LETTRE, DPE_VALEUR, GES_LETTRE, GES_VALEUR FROM VISITE_TPL_EU LEFT JOIN TYPE_BIEN ON TYPE_BIEN.ID_TYPE_BIEN=VISITE_TPL_EU.ID_TYPE_BIEN INNER JOIN UNITE_SURFACE ON UNITE_SURFACE.ID_UNITE_SURFACE=VISITE_TPL_EU.ID_UNITE_SURFACE_HABITABLE WHERE ID_VISITE='".$data_array['ID_VISITE']."'";
//	  		}else{
//	  			$sql = "SELECT ID_TYPE_TRANSACTION,ID_ADRESSE_CACHEE,VISITE_TPL_US.ID_TYPE_BIEN, NOM_TYPE_BIEN TYPE_BIEN,NOMBRE_CHAMBRE NB_BEDROOM,NOMBRE_SALLE_BAIN NB_BATHROOM,ESPACE_TOTAL SQUARE_FEET FROM VISITE_TPL_US LEFT JOIN VISITE_TPL_US_TYPE_BIEN ON VISITE_TPL_US_TYPE_BIEN.ID_TYPE_BIEN=VISITE_TPL_US.ID_TYPE_BIEN WHERE ID_VISITE='".$data_array['ID_VISITE']."'";
//	  		}
//			$result = db_query( $sql, $db_data['name']);
//			if($row = $result->fetchRow(DB_FETCHMODE_ASSOC)){
//				$data_array = array_merge($data_array, $row);	  		
//			}
//		}
//	}
//	return $data_array;
//}

//function get_video_conversions($id_video){
//	global $db_data;
//	$data_array = array();
//	if(is_guid($id_video)){
//		$sql = "SELECT ID_CONVERSION, DATE_MODIFICATION_CONVERSION, REF_VIDEO_PROFIL, ID_VIDEO, DATE_DEMANDE_CONVERSION, ID_STATUT_CONVERSION, NB_IMAGE, DATE_FIN_CONVERSION, RESULT_CODE_CONVERSION, RESULT_TEXT_CONVERSION, TYPE_CONVERSION FROM VIDEO_CONVERSION WHERE ID_VIDEO='".$id_video."' ORDER BY DATE_MODIFICATION_CONVERSION DESC";
//		$time = microtime(true);
//		$result = db_query($sql, $db_data['name']);
//		log_query(__FUNCTION__, $sql, microtime(true)-$time);
//		while($row = $result->fetchRow(DB_FETCHMODE_ASSOC)) {
//			if(!is_array($data_array[$row['ID_CONVERSION']])){ $data_array[$row['ID_CONVERSION']] = array();}
//			$data_array[$row['ID_CONVERSION']][$row['REF_VIDEO_PROFIL']] = $row;
//		}
//	}
//	return $data_array;
//}

//function get_conversion_infos($id_conversion){
//	global $db_data;
//	$data_array = array();
//	if(is_guid($id_conversion)){
//		$sql = "SELECT VIDEO.ID_VIDEO, ID_VISITE, ID_CONVERSION, ID_STATUT_CONVERSION, XML_SOURCE_CONVERSION, DATE_DEMANDE_CONVERSION, DATE_FIN_CONVERSION, TAILLE_VIDEO, URL_POST_CONVERSION, URL_NOTIFICATION_CONVERSION, RESULT_CODE_CONVERSION, RESULT_TEXT_CONVERSION, REF_VIDEO_PROFIL, TYPE_CONVERSION, ID_RESOURCE FROM VIDEO_CONVERSION INNER JOIN VIDEO ON VIDEO.ID_VIDEO=VIDEO_CONVERSION.ID_VIDEO WHERE ID_CONVERSION='".$id_conversion."' ORDER BY REF_VIDEO_PROFIL";
//		$time = microtime(true);
//		$result = db_query( $sql, $db_data['name']);
//		log_query(__FUNCTION__, $sql, microtime(true)-$time);
//		while($row = $result->fetchRow(DB_FETCHMODE_ASSOC)) {
//			$data_array[] = $row;
//		}
//	}
//	return $data_array;
//}

//function get_conversion_details($id_conversion){
//	global $db_data;
//	$data_array = array();
//	if(is_guid($id_conversion)){
//		$sql = "SELECT ID_VIDEO, ID_CONVERSION, XML_SOURCE_CONVERSION, REF_VIDEO_PROFIL FROM VIDEO_CONVERSION WHERE ID_CONVERSION='".$id_conversion."' ORDER BY REF_VIDEO_PROFIL";
//		$time = microtime(true);
//		$result = db_query($sql, $db_data['name']);
//		log_query(__FUNCTION__, $sql, microtime(true)-$time);
//		while($row = $result->fetchRow(DB_FETCHMODE_ASSOC)){ $data_array[] = $row;}
//	}
//	return $data_array;
//}

//function get_video_distributeur($id_visite){
//	global $db_data;
//	if(is_guid($id_visite)){
//		$sql = "SELECT ID_DISTRIBUTEUR FROM VISITE INNER JOIN SOCIETE ON SOCIETE.ID_SOCIETE=VISITE.ID_SOCIETE WHERE ID_VISITE='".$id_visite."'";
//		return db_getOne($sql, $db_data['name']);
//	}
//	return "";
//}

//function insert_video_infos_cron($id_video, $ref_video, $type, $distrib, $tour){
//	global $db_data;
//	if(is_guid($id_video) && is_guid($distrib) && is_guid($tour)){
//		$sql = "SELECT ID_VIDEO, ID_STATUT_VIDEO FROM VIDEO WHERE ID_VIDEO='".$id_video."'";
//		$time = microtime(true);
//		$result = db_query($sql, $db_data['name']);
//		$r = $result->fetchRow(DB_FETCHMODE_ASSOC);
//		log_query(__FUNCTION__, $sql, microtime(true)-$time);
//		$sql = "";
//		if(!is_guid($r['ID_VIDEO'])){
//			if($ref_video == ""){ $ref_video = substr($id_video,0,8);}
//			$sql = "INSERT VIDEO(ID_VIDEO,REF_VIDEO, DATE_CREATION_VIDEO, DATE_MODIFICATION_VIDEO, ID_STATUT_VIDEO, TYPE_VIDEO, ID_CRON, WAIT_TTS, ID_VISITE".(is_guid($distrib) ?  ", ID_DISTRIBUTEUR":"").") VALUES( '".$id_video."', '".fix_text($ref_video,20)."', '".date('Y-m-d H:i:s')."', '".date('Y-m-d H:i:s')."', '0', '".fix_text($type)."', '1', '1','".$tour."'".(is_guid($distrib) ?  ", '".$distrib."'":"").")";
//		}else if($r['ID_STATUT_VIDEO'] != 0){
//			$sql = "UPDATE VIDEO SET DATE_MODIFICATION_VIDEO='".date('Y-m-d H:i:s')."', ID_STATUT_VIDEO='0', TYPE_VIDEO='".fix_text($type)."', ID_CRON='1',  WAIT_TTS='1' WHERE ID_VIDEO='".$id_video."'";
//		}
//		if($sql != ""){ 
//			$time = microtime(true);
//			db_query($sql,$db_data['name']);
//			log_query(__FUNCTION__, $sql, microtime(true)-$time);
//		}
//		db_close();
//		$old_name = $db_data['name'];
//		$db_data['name'] = "video";
//		$sql = "SELECT ID_VISITE FROM VIDEO_CRON WHERE ID_VIDEO='".$id_video."'";
//		if(!is_guid(db_getOne($sql, $db_data['name']))){
//			$sql = "INSERT INTO VIDEO_CRON (Id_video, ID_VISITE, Id_distributeur, Id_statut_cron, Date_creation_cron, Date_modification_cron, Date_dernier_cron) VALUES('".$id_video."', '".$tour."', '".$distrib."', 0, '".date('Y-m-d H:i:s')."', '".date('Y-m-d H:i:s')."', '".date('Y-m-d H:i:s')."')";
//		}else{
//			$sql = "UPDATE VIDEO_CRON SET id_visite='".$tour."', id_distributeur='".$distrib."', Id_statut_cron=0, Date_modification_cron='".date('Y-m-d H:i:s')."', Date_dernier_cron='".date('Y-m-d H:i:s')."' WHERE ID_VIDEO='".$id_video."'";
//		}
//		db_query( $sql, $db_data['name']);
//		db_close();
//		$db_data['name'] = $old_name;
//	}
//}

//function update_video_infos( $id_tour, $ref_video, $type, $distrib, $wait_for_tts = false){
//	global $db_data;
//	$return = false;
//	if(is_guid($id_tour) && $type != ""){
//		$sql = "SELECT ID_VIDEO, ID_STATUT_VIDEO, WAIT_TTS, ID_CRON FROM VIDEO WHERE ID_VISITE='".$id_tour."' AND TYPE_VIDEO='".fix_text($type)."'";
//		$time = microtime(true);
//		$result = db_query($sql, $db_data['name']);
//		if($r = $result->fetchRow(DB_FETCHMODE_ASSOC)){
//			log_query(__FUNCTION__, $sql, microtime(true)-$time);
//			$id_video = $r['ID_VIDEO'];
//			if($wait_for_tts){ $r['WAIT_TTS'] = 1;}
//		}
//		$sql = "";
//		if(!is_guid($id_video)){
//			$id_video =	generate_guid();
//			if($ref_video == ""){ $ref_video = substr($id_video,0,8);}
//			$sql = "INSERT VIDEO(ID_VIDEO, ID_VISITE,REF_VIDEO, DATE_CREATION_VIDEO, DATE_MODIFICATION_VIDEO, ID_STATUT_VIDEO, TYPE_VIDEO, WAIT_TTS".(is_guid($distrib) ?  ", ID_DISTRIBUTEUR":"").") VALUES('".$id_video."', '".$id_tour."','".fix_text($ref_video,20)."', '".date('Y-m-d H:i:s')."', '".date('Y-m-d H:i:s')."','0','".fix_text($type)."','".$r['WAIT_TTS']."'".(is_guid($distrib) ?  ", '".$distrib."'":"").")";
//			$return = true;
//		}else if($r['ID_STATUT_VIDEO'] != 0){
//			$sql = "UPDATE VIDEO SET DATE_MODIFICATION_VIDEO='".date('Y-m-d H:i:s')."', ID_STATUT_VIDEO='0', WAIT_TTS='".$r['WAIT_TTS']."' WHERE ID_VIDEO='".$id_video."'";
//			$return = true;
//		}else if($r['ID_STATUT_VIDEO'] == 0 && $r['ID_CRON'] == 1){
//			$return = true;
//		}
//		if($sql != ""){ 
//			$time = microtime(true);
//			db_query($sql,$db_data['name']);
//			log_query(__FUNCTION__, $sql, microtime(true)-$time);
//		}
//	}
//	return ($return == true ? $id_video : $return);
//}
 
//function insert_conversion($id_video, $ref_video, $conversions, $tab_tour, $id_distributeur, $nbimg, $type, $wait_for_tts = false){
//	global $db_data;
//	$id = "";
//	$refs = array();
//	if(is_guid($id_video)){
//		$wait_for_tts_old = 0;
//		$sql = "SELECT ID_VIDEO, PROFIL_AVAILABLE, WAIT_TTS, ID_CRON FROM VIDEO WHERE ID_VIDEO='".$id_video."'";
//		$time = microtime(true);
//		$result = db_query( $sql, $db_data['name']);
//		log_query(__FUNCTION__, $sql, microtime(true)-$time);
//		if($r = $result->fetchRow(DB_FETCHMODE_ASSOC)){
//			$id = $r['ID_VIDEO'];
//			$tmp = explode(',',$r['PROFIL_AVAILABLE']);
//			$wait_for_tts_old = $r['WAIT_TTS'];
//			$id_cron = $r['ID_CRON'];
//			foreach($tmp as $v){ $refs[getProfilExt($v)] = $v;}
//		}

//		if(!is_guid($id)){
//			$sql= "INSERT INTO VIDEO(Id_video, Ref_video, Id_visite, Type_video, Date_creation_video, Date_modification_video, Id_statut_video, Id_distributeur, Profil_available, Wait_TTS, Id_cron, Nb_conversions) VALUES('".$id_video."', '".$ref_video."', '".$tab_tour['ID_VISITE']."', '".fix_text($type == "" ? "FR" : $type )."', '".date('Y-m-d H:i:s')."', '".date('Y-m-d H:i:s')."', 0, ".(is_guid($id_distributeur) ? "'".$id_distributeur."'" : "NULL")." , '', '".($wait_for_tts_old ? "1" : "0")."','0', '0')";
			
//			$time = microtime(true);
//			db_query( $sql, $db_data['name']);
//			log_query(__FUNCTION__, $sql, microtime(true)-$time);
//		}

//		if(is_array($conversions) && count($conversions) > 0){
//			foreach($conversions as $conv){
//				if($refs[getProfilExt($conv['ref'])] != ""){
//					$sql = "UPDATE VIDEO_CONVERSION SET ID_STATUT_CONVERSION='-1',RESULT_TEXT_CONVERSION='TIMEOUT - A NEW GENERATION HAS ASKED',RESULT_CODE_CONVERSION='-1' FROM VIDEO_CONVERSION WHERE ID_VIDEO='".$id_video."' AND REF_VIDEO_PROFIL='".$refs[getProfilExt($conv['ref'])]."' AND ID_STATUT_CONVERSION BETWEEN '0' AND '2'" ;
//				}
//				$sql = "INSERT INTO VIDEO_CONVERSION( ID_CONVERSION, REF_VIDEO_PROFIL, DATE_DEMANDE_CONVERSION, DATE_MODIFICATION_CONVERSION, ID_STATUT_CONVERSION, NB_IMAGE, URL_POST_CONVERSION, URL_NOTIFICATION_CONVERSION, XML_SOURCE_CONVERSION, ID_VIDEO, TYPE_CONVERSION, ID_RESOURCE)VALUES('".$conv['id']."', '".fix_text($conv['ref'])."', '".date('Y-m-d H:i:s')."', '".date('Y-m-d H:i:s')."', '0', '".$nbimg."', '".$conv['url_post']."', '".$conv['url_notification']."', '".fix_text($conv['xml'])."', '".$id_video."', '".$type."', '".$conv['resource']."')";
//				$time = microtime(true);
//				db_query( $sql, $db_data['name']); 
//				log_query(__FUNCTION__, $sql, microtime(true)-$time);
//				$refs[getProfilExt($conv['ref'])] = $conv['ref'];
//			}
//		}		
//		$profil_available = "";
//		foreach($refs as $r){ 
//			if($r != ""){ $profil_available .= ",".$r;}
//		}
//		$profil_available = preg_replace('/^,/','',$profil_available);
		
//		$sql = "UPDATE VIDEO SET ID_STATUT_VIDEO='0', PROFIL_AVAILABLE='".$profil_available."', REF_VIDEO='".fix_text($ref_video, 20)."'".(is_guid($id_distributeur) ? ", ID_DISTRIBUTEUR='".$id_distributeur."' " : "").", WAIT_TTS='".($wait_for_tts ? "1" : "0")."'".(!$wait_for_tts ? ", DATE_MODIFICATION_VIDEO='".date('Y-m-d H:i:s')."'" : "")." WHERE ID_VIDEO='".$id_video."'";
//		$time = microtime(true);
//		db_query( $sql, $db_data['name']);
//		log_query(__FUNCTION__, $sql, microtime(true)-$time);
		
//		$sql = "DELETE FROM VIDEO_CONVERSION WHERE ID_CONVERSION IN (SELECT ID_CONVERSION FROM (SELECT ROW_NUMBER() OVER (ORDER BY DATE_REF DESC) ROW,  ID_CONVERSION FROM (SELECT DISTINCT ID_CONVERSION, (SELECT MAX(DATE_MODIFICATION_CONVERSION) FROM VIDEO_CONVERSION DT WHERE DT.ID_CONVERSION=VIDEO_CONVERSION.ID_CONVERSION) DATE_REF FROM VIDEO_CONVERSION WHERE ID_VIDEO='".$id_video."') AS TAB) AS TAB WHERE ROW > 5)";
//		$time = microtime(true);
//		db_query($sql, $db_data['name']);	
//		log_query(__FUNCTION__, $sql, microtime(true)-$time);
		
//	}
//}

//function update_conversion_start($id_resource,$profile){
//	global $db_data;
//	$sql = "SELECT ID_VIDEO FROM VIDEO_CONVERSION WHERE ID_RESOURCE='".$id_resource."'  AND REF_VIDEO_PROFIL='".$profile."'";
//	$time = microtime(true);
//	$id_video = db_getOne($sql, $db_data['name']);
//	log_query(__FUNCTION__, $sql, microtime(true)-$time);
//	if(is_guid($id_video)){
//		$sql = "UPDATE VIDEO_CONVERSION SET ID_STATUT_CONVERSION='1', DATE_TRAITEMENT_CONVERSION='".date('Y-m-d H:i:s')."',DATE_MODIFICATION_CONVERSION='".date('Y-m-d H:i:s')."' WHERE ID_RESOURCE='".$id_resource."' AND REF_VIDEO_PROFIL='".$profile."'";
//		$time = microtime(true);
//		db_query( $sql, $db_data['name']);
//		log_query(__FUNCTION__, $sql, microtime(true)-$time);
//		$sql = "SELECT ID_CRON FROM VIDEO WHERE ID_VIDEO='".$id_video."'";
//		if(db_getOne($sql, $db_data['name']) == 1){ 
//			$sql = "UPDATE VIDEO SET DATE_MODIFICATION_VIDEO='".date('Y-m-d H:i:s')."', ID_CRON=2 WHERE ID_VIDEO='".$id_video."'";
//			$time = microtime(true);
//			db_query( $sql, $db_data['name']);
//			log_query(__FUNCTION__, $sql, microtime(true)-$time);
//			//update cron
//			$old_name = $db_data['name'];
//			$db_data['name'] = "video";
//			$sql = "UPDATE VIDEO_CRON SET Id_statut_cron=1, Date_modification_cron='".date('Y-m-d H:i:s')."', Date_dernier_cron='".date('Y-m-d H:i:s')."' WHERE ID_VIDEO='".$id_video."'";
//			db_query( $sql, $db_data['name']);
//			db_close();
//			$db_data['name'] = $old_name;
//		}
//	}
//}

//function update_conversion_complete( $id_resource, $profile){
//	global $db_data;
//	$sql = "SELECT ID_VIDEO FROM VIDEO_CONVERSION WHERE ID_RESOURCE='".$id_resource."' AND REF_VIDEO_PROFIL='".$profile."'";
//	$time = microtime(true);
//	$id_video = db_getOne($sql,$db_data['name']);
//	log_query(__FUNCTION__, $sql, microtime(true)-$time);
//	if(is_guid($id_video)){
//		$sql = "UPDATE VIDEO_CONVERSION SET ID_STATUT_CONVERSION='2', DATE_FIN_CONVERSION='".date('Y-m-d H:i:s')."',DATE_MODIFICATION_CONVERSION='".date('Y-m-d H:i:s')."' WHERE ID_RESOURCE='".$id_resource."' AND REF_VIDEO_PROFIL='".$profile."'";
//		$time = microtime(true);
//		db_query( $sql, $db_data['name']);
//		log_query(__FUNCTION__, $sql, microtime(true)-$time);
//	}
//}

//function get_last_conversion_state( $id_video, $tour, $type){
//	global $db_data;
//	$data_array = array();
//	$sql_where = "";
//	if(is_guid($id_video)){ $sql_where = "ID_VIDEO='".$id_video."'";}
//	else if(is_guid($tour) && $type != ""){ $sql_where = "ID_VISITE='".$tour."' AND TYPE_VIDEO='".$type."'";}
//	if($sql_where != ""){
//		$sql = "SELECT ID_STATUT_VIDEO,TYPE_VIDEO,(SELECT TOP 1 ID_CONVERSION FROM VIDEO_CONVERSION WHERE ID_VIDEO=VIDEO.ID_VIDEO ORDER BY DATE_MODIFICATION_CONVERSION DESC) ID_LAST_CONVERSION FROM VIDEO WHERE ".$sql_where;
//		$time = microtime(true);
//		$result = db_query( $sql, $db_data['name']);
//		log_query(__FUNCTION__, $sql, microtime(true)-$time);
//		if($row = $result->fetchRow(DB_FETCHMODE_ASSOC) ){
//			$data_array = $row;
//			if(is_guid($row['ID_LAST_CONVERSION'])){
//				$sql = "SELECT ID_STATUT_CONVERSION, TYPE_CONVERSION FROM VIDEO_CONVERSION WHERE ID_CONVERSION='".$row['ID_LAST_CONVERSION']."' ORDER BY ID_STATUT_CONVERSION ASC";
//				$time = microtime(true);
//				$result = db_query( $sql, $db_data['name']);	
//				log_query(__FUNCTION__, $sql, microtime(true)-$time);
//				if($row = $result->fetchRow(DB_FETCHMODE_ASSOC) ){
//					$data_array = array_merge($data_array,$row);
//				}
//			}
//		}
//	}
//	return $data_array;
//}

//function get_last_diffusion($filter = ""){
//	global $db_data;
//	$data_array = array();
//	$sql = "SELECT VIDEO.ID_VIDEO,ID_VISITE,ID_DISTRIBUTEUR, REF_VIDEO, SITE_DIFFUSION, LOGIN_DIFFUSION, PASSWORD_DIFFUSION, URL_VIDEO_DIFFUSION, DATE_MODIFICATION_DIFFUSION, RESULT_CODE_DIFFUSION, RESULT_TEXT_DIFFUSION, RESULT_DESCRIPTION_DIFFUSION, URL_NOTIFICATION_DIFFUSION, ID_STATUT_DIFFUSION, TITLE_DIFFUSION, ID_DISTRIBUTEUR, TYPE_VIDEO FROM VIDEO_DIFFUSION INNER JOIN VIDEO ON VIDEO.ID_VIDEO=VIDEO_DIFFUSION.ID_VIDEO ".$filter." ORDER BY DATE_MODIFICATION_DIFFUSION DESC";
//	$time = microtime(true);
//	$result = db_query( $sql, $db_data['name']);
//	log_query(__FUNCTION__, $sql, microtime(true)-$time);
//	while($row = $result->fetchRow(DB_FETCHMODE_ASSOC) ){
//		$data_array[] = $row;
//	}
//	return $data_array;
//}

//function get_diffusion_infos($id, $site, $login){
//	global $db_data;
//	$data_array = array();
//	if(is_guid($id) && $site !="" && $login != ""){
//		$sql = "SELECT VIDEO_DIFFUSION.ID_VIDEO, ID_VISITE, ID_DISTRIBUTEUR, TITLE_DIFFUSION, SITE_DIFFUSION, LOGIN_DIFFUSION, TYPE_VIDEO, PASSWORD_DIFFUSION, URL_NOTIFICATION_DIFFUSION, AUTO FROM VIDEO_DIFFUSION INNER JOIN VIDEO ON VIDEO.ID_VIDEO=VIDEO_DIFFUSION.ID_VIDEO WHERE VIDEO_DIFFUSION.ID_VIDEO='".$id."' AND SITE_DIFFUSION='".$site."' AND LOGIN_DIFFUSION='".$login."'";
//		$time = microtime(true);
//		$result = db_query( $sql, $db_data['name']);
//		log_query(__FUNCTION__, $sql, microtime(true)-$time);
//		while($row = $result->fetchRow(DB_FETCHMODE_ASSOC) ){
//			//if(!is_array($data_array[$row['ID_VIDEO']])){ $data_array[$row['ID_VIDEO']] = array();}
//			$data_array = $row;
//		}	
//	}
//	return $data_array;
//}

//function getSounds(){
//	global $db_data;
//	$data_array = array();
//	if(is_guid($id_sound)){
//		$sql = "SELECT ID_MUSIQUE_VIDEO FROM MUSIQUE_VIDEO WHERE ID_STATUT_MUSIQUE > 0";
//		$time = microtime(true);
//		$result = db_query($sql, $db_data['name']);
//		log_query(__FUNCTION__, $sql, microtime(true)-$time);
//		while($row = $result->fetchRow(DB_FETCHMODE_ASSOC) ){
//			$data_array[] = $row;
//		}
//	}
//	return $data_array;
//}

//function getDurationMusic($id_sound){
//	global $db_data;
//	$result = false;
//	if(is_guid($id_sound)){
//		$sql = "SELECT DUREE_MUSIQUE_VIDEO FROM MUSIQUE_VIDEO WHERE ID_MUSIQUE_VIDEO='".$id_sound."'";
//		$result = db_getOne($sql, $db_data['name']);
//	}
//	return $result;
//}

//function getSoundState($id_sound){
//	global $db_data;
//	$result = -1;
//	if(is_guid($id_sound)){
//		$sql = "SELECT ID_STATUT_MUSIQUE FROM MUSIQUE_VIDEO WHERE ID_MUSIQUE_VIDEO='".$id_sound."' AND ID_STATUT_MUSIQUE > 0";
//		$result = db_getOne($sql, $db_data['name']);
//	}
//	return ($result >= 0);
//}

//function getProfilExt($profil){
//	global $db_data;
//	$result = false;
//	if($profil != ""){
//		$sql = "SELECT EXTENSION FROM VIDEO_PROFIL WHERE REF_VIDEO_PROFIL='".strtolower($profil)."' AND ID_STATUT_PROFIL > 0";
//		$result = db_getOne($sql, $db_data['name']);
//	}
//	return $result;
//}

//function getProfilGroupByExt(){
//	global $db_data;
//	$data_array = array();
//	$sql = "SELECT REF_VIDEO_PROFIL,EXTENSION FROM VIDEO_PROFIL WHERE ID_STATUT_PROFIL > 0 ORDER BY REF_VIDEO_PROFIL";
//	$result = db_query( $sql, $db_data['name']);
//	while($row = $result->fetchRow(DB_FETCHMODE_ASSOC)){
//		if(!is_array($data_array[$row['EXTENSION']])){ $data_array[$row['EXTENSION']] = array();}
//		$data_array[$row['EXTENSION']][] = $row['REF_VIDEO_PROFIL'];
//	}
//	return $data_array;
//}


//function getDiffusionStats(){
//	global $db_data;
//	$data_array = array('inprogress' =>array(), 'wait'=>array());
//	$sql = "SELECT ID_STATUT_CRON,NOM_DISTRIBUTEUR,count(*) nb from VIDEO_CRON INNER JOIN DISTRIBUTEUR ON DISTRIBUTEUR.ID_DISTRIBUTEUR=VIDEO_CRON.ID_DISTRIBUTEUR WHERE ID_STATUT_CRON=1 OR ID_STATUT_CRON=0 group by ID_STATUT_CRON,NOM_DISTRIBUTEUR ORDER BY NOM_DISTRIBUTEUR";
//	$time = microtime(true);
//	$result = db_query( $sql, $db_data['name']);
//	log_query(__FUNCTION__, $sql, microtime(true)-$time);
//	while($row = $result->fetchRow(DB_FETCHMODE_ASSOC)){
//		$data_array[($row['ID_STATUT_CRON'] == 1 ?'inprogress' : 'wait')][$row['NOM_DISTRIBUTEUR']] = $row['nb'];
//	}
//	return $data_array;
//}
/**
*
*	VIDEOTOUR
*
*/
//function get_videotour_data($id_videotour){
//	$data_array = array();
//	if(is_guid($id_videotour)){
//		$sql = "SELECT ID_VIDEOTOUR,DESCRIPTION_VIDEOTOUR DESCRIPTION,ADDRESS_VIDEOTOUR ADRESSE,CITY_VIDEOTOUR VILLE,ZIP_VIDEOTOUR CODE_POSTAL,ROOM_VIDEOTOUR ROOM,SQUARE_FEET_VIDEOTOUR SQUARE_FEET,BATHROOM_VIDEOTOUR NB_BATHROOM,PRICE_VIDEOTOUR PRICE,ID_MUSIC_VIDEOTOUR ID_MUSIQUE_VIDEO,NB_IMAGE,ID_STATUT_VIDEOTOUR,CONTACT_VIDEOTOUR CONTACT,TITLE_VIDEOTOUR NOM_VISITE,ID_COUNTRY ID_PAYS,MEASURE_UNIT,TTS_VOICE FROM VIDEOTOUR WHERE ID_VIDEOTOUR='".$id_videotour."'";
// // 	$result = db_query($sql,"videotour");
//  //	if($row = $result->fetchRow(DB_FETCHMODE_ASSOC)) {
//  		$data_array = $row;
//			$data_array['DESCRIPTION'] = preg_replace('/\v/',' ',$data_array['DESCRIPTION']);
//  	}
//	}
//	return $data_array;
//}

/**
*	list db
**/
//function getListDistrib(){
//	$data_array = array();
//	$sql = "SELECT ID_DISTRIBUTEUR, NOM_DISTRIBUTEUR, ID_PAYS_DISTRIBUTEUR, NOM_PAYS NOM_PAYS_DISTRIBUTEUR FROM DISTRIBUTEUR INNER JOIN PAYS ON PAYS.ID_PAYS=DISTRIBUTEUR.ID_PAYS_DISTRIBUTEUR WHERE ID_STATUT_DISTRIBUTEUR > 0 ORDER BY NOM_PAYS, NOM_DISTRIBUTEUR";
//	$result = db_query($sql, "main");
//	while($r = $result->fetchRow(DB_FETCHMODE_ASSOC)){ $data_array[] = $r;}
//	return $data_array;
//}

