<?php

function get_image_list($tour) {
	global $db;
	$data_array = array();
	if(is_guid($tour)){
		$sql = <<<SQL
SELECT
	i.ID_IMAGE, i.ID_TYPE_IMAGE, i.ID_TYPE_VUE,i.POIDS, t.NOM_IMAGE 
FROM
	VISITE v
	INNER JOIN IMAGE i ON v.ID_VISITE=i.ID_VISITE AND ID_STATUT_IMAGE>-1
	LEFT JOIN TITRE_IMAGE t ON i.ID_IMAGE=t.ID_IMAGE AND t.ID_LANGUE=v.ID_LANGUE
WHERE
	i.ID_VISITE=?
SQL;
		$result = $db->query($sql, array($tour));
		while($row = $result->fetchRow(DB_FETCHMODE_ASSOC)){ 
			$idx = str_pad($row['POIDS'], 3, '0', STR_PAD_LEFT).$row['ID_IMAGE'];
			$data_array[$idx] = $row;
		}
		if(!empty($data_array)){
			ksort($data_array, SORT_STRING);
			$data_array = array_values($data_array);
		}
	}
	return $data_array;
}

function get_tour_custom_contact($tour) {
	global $db;
	$data_array = array();
	if(is_guid($tour)){
		$sql = 'SELECT NOM_UTILISATEUR, NOM_SOCIETE, ADRESSE_SOCIETE, TELEPHONE_SOCIETE, VILLE_SOCIETE, CODE_POSTAL_SOCIETE, PRENOM_UTILISATEUR, EMAIL_UTILISATEUR, TELEPHONE_UTILISATEUR, NOM_LOGO_SOCIETE,SITEWEB_SOCIETE FROM VISITE_INFO_CONTACT WHERE ID_VISITE=?';
		$data_array = $db->getRow($sql, array($tour), DB_FETCHMODE_ASSOC);
	}
	return $data_array;
}

function get_user_data($user, $partner=null) {
	global $db;
	$data_array = array();
	if(is_guid($user)){
		$sql = <<<SQL
SELECT
	u.ID_UTILISATEUR, s.ID_SOCIETE, s.ID_DISTRIBUTEUR, d.NOM_DISTRIBUTEUR, s.NOM_SOCIETE, s.SITEWEB_SOCIETE, s.REF_DEVISE, s.GROUPE_SOCIETE, s.COMMENTAIRE AS NOM_SOCIETE2, u.ID_STATUT_UTILISATEUR,
	u.NOM_UTILISATEUR, u.PRENOM_UTILISATEUR, u.ID_CIVILITE_UTILISATEUR, u.EMAIL_UTILISATEUR, U.QUALITE_UTILISATEUR, u.ID_LANGUE, u.TELEPHONE_UTILISATEUR, u.MOBILE_UTILISATEUR, u.ANGLE_LENTILLE,
	a.TELEPHONE, a.ADRESSE, a.CODE_POSTAL, a.ETAT,a.ID_PAYS,a.VILLE, u.NOMBRE_IMAGES,u.FORMAT_AUTORISE,u.PHOTO_UTILISATEUR,u.VERSION_VIEWER,u.URL_PHOTO,u.LOGIN_UTILISATEUR,u.PASSWORD_UTILISATEUR,s.ID_TEMPLATE,s.LOGO_SOCIETE,
	(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='DATA_USER' AND REF_OPTION='IDLOGOUSER') AS ID_LOGO_USER,
	(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='DATA_USER' AND REF_OPTION='IDLOGOUSEREXT') AS ID_LOGO_USER_EXT,
	(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='DATA_USER' AND REF_OPTION='IDLOGOSOCIETE') AS ID_LOGO_SOCIETE,
	(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='DATA_USER' AND REF_OPTION='IDLOGOSOCIETEEXT') AS ID_LOGO_SOCIETE_EXT,
	(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='DATA_USER' AND REF_OPTION='IDLOGOVIDEO') AS ID_LOGO_VIDEO,
	(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='DATA_USER' AND REF_OPTION='IDLOGOVIDEOEXT') AS ID_LOGO_VIDEO_EXT,
	(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='OPTION_BUNDLE' AND REF_OPTION='DEFAULTBGMUSIC') AS ID_MUSIQUE_USER,
	(SELECT VALEUR_OPTION FROM DISTRIBUTEUR_OPTION WHERE ID_DISTRIBUTEUR=s.Id_DISTRIBUTEUR AND REF_CATEGORIE_OPTION='OPTION_DIFFUSION' AND REF_OPTION='LOGOAGENT') AS ID_LOGO_DISTRIB,	
	(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='OPTION_DIFFUSION' AND REF_OPTION='FORCEVIDURLTOUR') AS FORCE_TOUR_URL_USER,	
	(SELECT VALEUR_OPTION FROM DISTRIBUTEUR_OPTION WHERE ID_DISTRIBUTEUR=s.Id_DISTRIBUTEUR AND REF_CATEGORIE_OPTION='OPTION_DIFFUSION' AND REF_OPTION='FORCEVIDURLTOUR') AS FORCE_TOUR_URL_DISTRIB,
	(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='OPTION_BUNDLE' AND REF_OPTION='VIDEOMOBILE') AS VIDEO_MOBILE_USER,		
	(SELECT VALEUR_OPTION FROM DISTRIBUTEUR_OPTION WHERE ID_DISTRIBUTEUR=s.Id_DISTRIBUTEUR AND REF_CATEGORIE_OPTION='OPTION_BUNDLE' AND REF_OPTION='VIDEOMOBILE') AS VIDEO_MOBILE_DISTRIB,
	(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='OPTION_DIFFUSION' AND REF_OPTION='CUSTOMVIDEOTAGS') AS TAGS_USER,
	(SELECT VALEUR_OPTION FROM DISTRIBUTEUR_OPTION WHERE ID_DISTRIBUTEUR=s.Id_DISTRIBUTEUR AND REF_CATEGORIE_OPTION='OPTION_DIFFUSION' AND REF_OPTION='CUSTOMVIDEOTAGS') AS TAGS_DISTRIB,
	(SELECT VALEUR_OPTION FROM DISTRIBUTEUR_OPTION WHERE ID_DISTRIBUTEUR=s.Id_DISTRIBUTEUR AND REF_CATEGORIE_OPTION='OPTION_BUNDLE' AND REF_OPTION='URLEXPORTLISTING') AS URL_EXPORT_LISTING,
	(SELECT VALEUR_OPTION FROM DISTRIBUTEUR_OPTION WHERE ID_DISTRIBUTEUR=s.Id_DISTRIBUTEUR AND REF_CATEGORIE_OPTION='OPTION_BUNDLE' AND REF_OPTION='URLCUSTOMLISTING') AS URL_CUSTOM_LISTING,
	(SELECT VALEUR_OPTION FROM DISTRIBUTEUR_OPTION WHERE ID_DISTRIBUTEUR=s.Id_DISTRIBUTEUR AND REF_CATEGORIE_OPTION='OPTION_BUNDLE' AND REF_OPTION='BLOCKTTSAUTO') AS BLOCKTTSAUTO_DISTRIB,
	(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='OPTION_BUNDLE' AND REF_OPTION='BLOCKTTSAUTO') AS BLOCKTTSAUTO,
	(SELECT VALEUR_OPTION FROM DISTRIBUTEUR_OPTION WHERE ID_DISTRIBUTEUR=s.Id_DISTRIBUTEUR AND REF_CATEGORIE_OPTION='OPTION_DIFFUSION' AND REF_OPTION='VIDNOSHORTURL') AS NO_SHORT_URL_DISTRIB,
	(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='OPTION_DIFFUSION' AND REF_OPTION='VIDNOSHORTURL') AS NO_SHORT_URL,
	(SELECT VALEUR_OPTION FROM DISTRIBUTEUR_OPTION WHERE ID_DISTRIBUTEUR=s.Id_DISTRIBUTEUR AND REF_CATEGORIE_OPTION='OPTION_DIFFUSION' AND REF_OPTION='VIDNOURL') AS NO_URL_DISTRIB,
	(SELECT VALEUR_OPTION FROM UTILISATEUR_OPTION WHERE ID_UTILISATEUR=u.ID_UTILISATEUR AND REF_CATEGORIE_OPTION='OPTION_DIFFUSION' AND REF_OPTION='VIDNOURL') AS NO_URL,
	cp.PREFIXE_PORTAIL
FROM
	UTILISATEUR u 
	INNER JOIN SOCIETE s ON u.ID_SOCIETE=s.ID_SOCIETE
	INNER JOIN DISTRIBUTEUR d ON s.ID_DISTRIBUTEUR=d.ID_DISTRIBUTEUR
	INNER JOIN ADRESSE a ON s.ID_ADRESSE_VIEWER=a.ID_ADRESSE

	-- 2012-08-06 : Check si client worldposting
	LEFT JOIN CLIENT_PORTAIL cp ON cp.ID_PORTAIL='19A2E13B-D292-AD02-0549-27AF56F7ACA6' AND u.ID_UTILISATEUR=cp.ID_UTILISATEUR
WHERE
	u.ID_UTILISATEUR=? AND u.DATE_ACTIVATION <= GETDATE()
SQL;
		$data_array = $db->getRow($sql, array($user), DB_FETCHMODE_ASSOC);
		$video_options = array('BLOCKTTSAUTO', 'NO_URL', 'NO_SHORT_URL');
		foreach($video_options as $video_option){
			if($data_array[$video_option.'_DISTRIB'] == "1"){
				$data_array[$video_option] = "1";
			}
			unset($data_array[$video_option.'_DISTRIB']);
		}
		if(empty($data_array['ID_LOGO_USER_EXT'])) {
			$data_array['ID_LOGO_USER_EXT'] = 'jpg';
		}
		if(empty($data_array['ID_LOGO_SOCIETE_EXT'])) {
			$data_array['ID_LOGO_SOCIETE_EXT'] = 'jpg';
		}
		if(empty($data_array['ID_LOGO_VIDEO_EXT'])) {
			$data_array['ID_LOGO_VIDEO_EXT'] = 'jpg';
		}
		
		// 2012-08-06 : Si client worldposting sans url export custom, rajouter url en wpost.in au lieu de pvt.fm
		if(empty($data_array['URL_EXPORT_LISTING']) && !empty($data_array['PREFIXE_PORTAIL'])) {
			$data_array['URL_EXPORT_LISTING'] = 'http://wpost.in/p/#PUB#';
		}
		
		
		if(empty($data_array['URL_EXPORT_LISTING'])) {
			$sql = 'SELECT VALEUR_OPTION AS URL_EXPORT_LISTING FROM OPTION_GLOBAL WHERE REF_CATEGORIE_OPTION=? AND REF_OPTION=?';
			$data_array['URL_EXPORT_LISTING'] = $db->getOne($sql, array('OPTION_BUNDLE', 'URLEXPORTLISTING'));
		}
		if(!empty($partner) && is_guid($data_array['ID_UTILISATEUR'])) {
			$sql = 'SELECT PREFIXE_PORTAIL, PASSWORD_PORTAIL FROM CLIENT_PORTAIL WHERE ID_PORTAIL=? AND ID_SOCIETE=? AND ID_UTILISATEUR=?';
			$tmp = $db->getRow($sql, array($partner, $data_array['ID_SOCIETE'], $data_array['ID_UTILISATEUR']), DB_FETCHMODE_ASSOC);
			$data_array['PARTNER_INFO'] = $tmp;
			if($tmp['PREFIXE_PORTAIL'] != ""){
				$sql = 'SELECT NOM_PLAYLIST, FILTRE_PLAYLIST FROM PORTAIL_PLAYLIST WHERE ID_PORTAIL=? AND LOGIN_PORTAIL=? AND ID_STATUT_PLAYLIST > 0';
				$res = $db->getAll($sql, array($partner, $tmp['PREFIXE_PORTAIL']), DB_FETCHMODE_ASSOC);
				$tmp = array();
				for($i=0; isset($res[$i]); $i++){
					$res[$i]['FILTRE_PLAYLIST'] = json_decode($res[$i]['FILTRE_PLAYLIST'], true);
					$tmp[] = $res[$i];
				}
				if(count($tmp) > 0){
					$data_array['PARTNER_INFO']['PLAYLIST'] = $tmp;
				}
			}
		}
	}
	return $data_array;
}


function get_tour_data($tour, $partner=null) {
	global $db;

	$data_array = array();
	if(is_guid($tour)){
		// DESCRIPTION
		$sql = <<<SQL
SELECT
	V.ID_VISITE,v.ID_TEMPLATE,v.ID_PAYS,v.REF_ETAT, v.ADRESSE, v.VILLE , v.CODE_POSTAL , 
	d.REF_DEVISE, d.SYMBOLE_DEVISE, d.SYMBOLEBRUT_DEVISE, 
	v.ID_UTILISATEUR, v.PRIX_BIEN, v.REF_VOICE, v.REF_VISITE, v.CACHER_LOCALISATION,
	v.ID_MUSIQUE_VIDEO, v.LONGITUDE, v.LATITUDE, v.URL_ANNONCE, v.ID_LANGUE, v.TYPE_SON, v.ID_SOCIETE, v.ID_STATUT_VISITE,
	VT.DESCRIPTION, VT.NOM_VISITE, VT.VOISINNAGE,
	S.ID_DISTRIBUTEUR
FROM
	VISITE V
	INNER JOIN SOCIETE s ON V.ID_SOCIETE=s.ID_SOCIETE
	LEFT JOIN DEVISE D ON D.REF_DEVISE = V.REF_DEVISE
	LEFT JOIN VISITE_TEXTE VT ON V.ID_VISITE=VT.ID_VISITE AND V.ID_LANGUE COLLATE French_CI_AS=VT.ID_LANGUE COLLATE French_CI_AS
WHERE
	V.ID_VISITE=?
SQL;

		$data_array = $db->getRow($sql, array($tour), DB_FETCHMODE_ASSOC);

		if(use_old_field() && (empty($data_array['NOM_VISITE']) || empty($data_array['DESCRIPTION']))) {
			$sql = 'SELECT NOM_VISITE, DESCRIPTION FROM VISITE WHERE ID_VISITE=?';
			$tmp = $db->getRow($sql, array($tour), DB_FETCHMODE_ASSOC);
			if(!PEAR::isError($tmp)) {
				$data_array = array_merge($data_array, $tmp);
			}
		}
		
		$sql = <<<SQL
SELECT
	vt.ID_LANGUE, vt.NOM_VISITE, vt.DESCRIPTION, vt.DESCRIPTION_VIDEO, vt.VOISINNAGE, vt.EQUIPEMENTS
FROM
	VISITE v
	-- Langues autres que langue defaut visite
	INNER JOIN VISITE_TEXTE VT ON V.ID_VISITE=VT.ID_VISITE
WHERE
	v.ID_VISITE=?
SQL;
		$res = $db->getAll($sql, array($tour), DB_FETCHMODE_ASSOC);

		for($i=0; isset($res[$i]); $i++) {
			$data_array['TEXTS'][$res[$i]['ID_LANGUE']] = array(
				'NOM_VISITE' => $res[$i]['NOM_VISITE'],
				'DESCRIPTION' => $res[$i]['DESCRIPTION'],
				'DESCRIPTION_VIDEO' => $res[$i]['DESCRIPTION_VIDEO'],
				'VOISINNAGE' => $res[$i]['VOISINNAGE'],
				'EQUIPEMENTS' => $res[$i]['EQUIPEMENTS']
			);
		}



		if(!empty($data_array)) {
			if($data_array['REF_ETAT'] != ""){
				$sql = <<<SQL
SELECT NOM_ETAT FROM ETATS WHERE ID_PAYS=? AND REF_ETAT=?					
SQL;
				$row = $db->getRow($sql, array($data_array['ID_PAYS'], $data_array['REF_ETAT']), DB_FETCHMODE_ASSOC);
	  		if(!empty($row)) {
	  			$data_array = array_merge($data_array,$row);
	  		}
			}

			if(23==$data_array['ID_TEMPLATE']){
				// Tpl auto
				$sql = <<<SQL
SELECT
	vta.ID_MARQUE, ma.NOM_MARQUE, vta.ID_MODELE, mo.NOM_MODELE, vta.ID_VERSION, NOMBRE_PORTE, NOMBRE_PLACE, PUISSANCE_FISCALE, PUISSANCE_MOTEUR, NOMBRE_VITESSE, ANNEE_MODELE,
	DATE_PREMIERE_IMMATRICULATION, COULEUR_EXTERIEURE, ID_NEUF,
	TV.NOM_TYPE_VEHICULE, tb.NOM_TYPE_BOITE, te.NOM_TYPE_ENERGIE, DISTANCE_PARCOURUE, NOM_UNITE_DISTANCE, OPTIONS
FROM
	VISITE_TPL_AUTO vta
	LEFT JOIN AUTO_MARQUE ma on vta.ID_MARQUE=ma.ID_MARQUE
	LEFT JOIN AUTO_MODELE mo on VTA.ID_MODELE=mo.ID_MODELE
	LEFT JOIN AUTO_TYPE_VEHICULE tv ON vta.ID_TYPE_VEHICULE=tv.ID_TYPE_VEHICULE
	LEFT JOIN AUTO_TYPE_ENERGIE te ON vta.ID_TYPE_ENERGIE=te.ID_TYPE_ENERGIE
	LEFT JOIN AUTO_TYPE_BOITE tb ON vta.ID_TYPE_BOITE=tb.ID_TYPE_BOITE
	LEFT JOIN UNITE_DISTANCE ud ON vta.ID_UNITE_DISTANCE_PARCOURUE=ud.ID_UNITE_DISTANCE
WHERE
	vta.ID_VISITE=?
SQL;
			} else if(21!=$data_array['ID_TEMPLATE']){
				// Tpl EU
				$sql = <<<SQL
SELECT
	ID_TYPE_TRANSACTION, ID_ADRESSE_CACHEE, ID_TYPE_BIEN, NOMBRE_PIECE NB_ROOM, NOMBRE_DEMI_PIECE AS HALF_ROOM, NOMBRE_CHAMBRE NB_BEDROOM, NOMBRE_SALLE_BAIN NB_BATHROOM, 
	SURFACE_HABITABLE AS SQUARE_FEET, NOM_UNITE_SURFACE, DPE_LETTRE, DPE_VALEUR, GES_LETTRE, GES_VALEUR, ID_PRESTIGE, ID_EXCLUSIVITE EXCLUSIVITE, NOMBRE_PARKING_INT, NOMBRE_PARKING_EXT, 
	ID_CAVE CAVE, NOMBRE_BALCON BALCON, NOMBRE_TERRASSE TERRASSE, 
	ID_JARDIN JARDIN, ID_LUMIERE LUMIERE, ID_TYPE_CUISINE, ID_TYPE_CHAUFFAGE, ID_ASCENSEUR ASCENSEUR, NOMBRE_GARAGE GARAGE, ID_PISCINE PISCINE, ID_TRAVAUX TRAVAUX, NOMBRE_ETAGES, NUMERO_ETAGE ETAGE, ID_NEUF NEUF, ID_BIEN_AMENAGE BIEN_AMENAGE,
	SURFACE_TERRAIN, ID_UNITE_SURFACE_TERRAIN, ID_EMAIL_RESTRICTION,
	ID_UNITE_SURFACE_HABITABLE, ID_PERIODICITE_LOYER
	
FROM
	VISITE_TPL_EU 
	INNER JOIN UNITE_SURFACE ON UNITE_SURFACE.ID_UNITE_SURFACE=VISITE_TPL_EU.ID_UNITE_SURFACE_HABITABLE
WHERE
	ID_VISITE=?
SQL;
			} else {
				// Tpl US
				$sql = <<<SQL
SELECT
	ID_TYPE_TRANSACTION,ID_ADRESSE_CACHEE, ID_TYPE_BIEN, NOMBRE_PIECE NB_ROOM, NOMBRE_CHAMBRE NB_BEDROOM,NOMBRE_SALLE_BAIN NB_BATHROOM,ESPACE_TOTAL SQUARE_FEET, NOM_UNITE_SURFACE, EQUIPEMENTS,
	ID_BIEN_AMENAGE BIEN_AMENAGE, ID_JARDIN JARDIN, ID_LUMIERE LUMIERE, NOMBRE_BALCON BALCON, NOMBRE_GARAGE GARAGE, ID_PISCINE PISCINE, ID_NEUF NEUF,
	TAILLE_LOT_ACRES AS SURFACE_TERRAIN, ID_UNITE_TAILLE_LOT AS ID_UNITE_SURFACE_TERRAIN, ID_EMAIL_RESTRICTION,
	ID_UNITE_SURFACE_HABITABLE, ID_PERIODICITE_LOYER
FROM
	VISITE_TPL_US
	LEFT JOIN UNITE_SURFACE ON UNITE_SURFACE.ID_UNITE_SURFACE=VISITE_TPL_US.ID_UNITE_SURFACE_HABITABLE
WHERE
	ID_VISITE=?
SQL;
			}
			$row = $db->getRow($sql, array($tour), DB_FETCHMODE_ASSOC);

			// 2012-08-27 : Ajout Location temporaire Argentine
			if(5==$row['ID_TYPE_TRANSACTION'] || 4==$row['ID_TYPE_TRANSACTION']) {
				$row['ID_TYPE_BIEN'] = 2;
				$row['LOCATION_TEMPORAIRE'] = true;
			}

  		if(!empty($row)) {
  			if($row['ID_TYPE_BIEN'] == '99'){
  				$row['TYPE_BIEN'] = '';
  			}
  			if($row['HALF_ROOM'] == '1') {
  				$row['NB_ROOM'] += 0.5;
  			}
  			$data_array = array_merge($data_array,$row);
  		}

			$sql = <<<SQL
SELECT
	NOM_TYPE_BIEN 
FROM
	TYPE_BIEN_DISTRIBUTEUR 
	INNER JOIN SOCIETE ON SOCIETE.ID_DISTRIBUTEUR=TYPE_BIEN_DISTRIBUTEUR.ID_DISTRIBUTEUR 
WHERE
	ID_SOCIETE=? AND ID_LANGUE=? AND ID_TYPE_BIEN=?
SQL;
			$result = $db->getOne($sql, array($data_array['ID_SOCIETE'], $data_array['ID_LANGUE'], $data_array['ID_TYPE_BIEN']));
			if(!empty($result)) {
				$data_array['TYPE_BIEN'] = $result;
			}

			// RS 2012-03-01 : Bug type_bien US 
			// Si pas de type bien custom pour le distrib et template US, prendre les types de VISITE_TPL_US_TYPE_BIEN
			
			// RS 2012-05-14 : Ben non en fait...		
			if(false && empty($data_array['TYPE_BIEN']) && 21==$data_array['ID_TEMPLATE']) {
				$sql = 'SELECT NOM_TYPE_BIEN FROM VISITE_TPL_US_TYPE_BIEN WHERE ID_TYPE_BIEN=?';
				$result = $db->getOne($sql, array($data_array['ID_TYPE_BIEN']));
				$data_array['TYPE_BIEN'] = $result;
			}

			$data_array['PLANS'] = array();
			$sql = "SELECT ID_PLAN,EXTENSION_FICHIER FROM [PLAN] WHERE ID_STATUT_PLAN >0 AND ID_VISITE=? ORDER BY ORDRE_PLAN";
			$result = $db->query($sql, array($tour));
			while($r = $result->fetchRow(DB_FETCHMODE_ASSOC)){
				if(empty($r['EXTENSION_FICHIER'])) {
					$r['EXTENSION_FICHIER'] = "jpg";
				}
				$data_array['PLANS'][] = $r;
			}
			
			// RS 2012-03-27 : Useless ????			
//			if(false && empty($data_array['URL_ANNONCE'])) {
//				$sql = "SELECT VALEUR_OPTION FROM DIFFUSION_PORTAIL_OPTION INNER JOIN DIFFUSION_PORTAIL ON DIFFUSION_PORTAIL.ID_DIFFUSION_PORTAIL=DIFFUSION_PORTAIL_OPTION.ID_DIFFUSION_PORTAIL WHERE ID_VISITE=? AND REF_OPTION='URL_ANNONCE'";
//				$data_array['URL_ANNONCE'] = $db->getOne($sql,array($tour));
//				if(empty($data_array['URL_ANNONCE'])) {
//					$data_array['URL_ANNONCE'] .= 'http://tour.previsite.com/'.$tour;
//				}
//			}

			if(is_guid($partner)){
				$sql = 'SELECT TOP 1 ID_DIFFUSION_PORTAIL, REF_PORTAIL FROM DIFFUSION_PORTAIL WHERE ID_VISITE=? AND ID_PORTAIL=?';
				$res = $db->getRow($sql, array($tour, $partner), DB_FETCHMODE_ASSOC);
				if(!empty($res['ID_DIFFUSION_PORTAIL'])) {
					$data_array['REF_PORTAIL'] = $res['REF_PORTAIL'];
					$data_array['ID_DIFFUSION_PORTAIL'] = $res['ID_DIFFUSION_PORTAIL'];
					$sql = "SELECT VALEUR_OPTION FROM DIFFUSION_PORTAIL_OPTION WHERE ID_DIFFUSION_PORTAIL=?";
					$data_array['TITLE_DIFFUSION'] = $db->getOne($sql, array($res['ID_DIFFUSION_PORTAIL'])); 
				}
			}
			
			$sql = 'SELECT NOM_CHAMP, VALEUR_CHAMP FROM VISITE_COMPLEMENT WHERE ID_VISITE=?';
			$result = $db->query($sql, array($tour));
			while($r = $result->fetchRow(DB_FETCHMODE_ASSOC)){
				$data_array['COMPLEMENTS'][$r['NOM_CHAMP']] = $r['VALEUR_CHAMP'];
			}
		}
	}
	return $data_array;
}

